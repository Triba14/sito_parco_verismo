{% extends "parco_verismo/base.html" %}
{% load static i18n %}
{% block title %}{% trans 'Calendario Eventi - Parco Letterario Verismo' %}{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/calendario.css' %}">
{% endblock %}
{% block hero_section %}{% endblock %}
{% block content %}
<section class="container my-5 pt-5">
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold mb-3" style="color: var(--color-text-primary);">
      <i class="bi bi-calendar-week me-3" style="color: var(--color-primary);"></i>
      {% trans 'Calendario Eventi' %}
    </h1>
    <p class="lead text-secondary mb-0">
      {% trans 'Consulta il calendario completo degli eventi e salva i tuoi preferiti' %}
    </p>
  </div>

  <div class="row">
    <div class="col-lg-11 mx-auto">
      <div id="calendar"></div>
    </div>
  </div>
</section>

<!-- Modal per dettagli evento -->
<div class="modal fade" id="eventoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0" style="box-shadow: var(--shadow-lg)">
      <div class="modal-header" style="background: var(--color-primary); color: var(--color-text-inverse); border-bottom: none;">
        <h5 class="modal-title fw-semibold" id="eventoModalTitle">
          <i class="bi bi-calendar-event me-2"></i>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="eventoModalBody"></div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Chiudi' %}</button>
        <a href="#" id="eventoDetailLink" class="btn btn-primary">
          <i class="bi bi-info-circle me-1"></i>{% trans 'Vedi dettagli completi' %}
        </a>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/it.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% get_current_language as LANGUAGE_CODE %}
    const languageCode = '{{ LANGUAGE_CODE }}' || 'it';
    const locale = languageCode;
    const jsLocale = languageCode === 'it' ? 'it-IT' : 'en-US';

    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      initialView: 'dayGridMonth',
      locale: locale,
      firstDay: 1,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listMonth'
      },
      buttonText: {
        today: '{% trans "Oggi" %}',
        month: '{% trans "Mese" %}',
        week: '{% trans "Settimana" %}',
        list: '{% trans "Lista" %}',
      },
      events: [
        {% for evento in eventi %}
        {
          id: '{{ evento.id }}',
          title: '{{ evento.titolo|escapejs }}',
          start: '{{ evento.data_inizio|date:"Y-m-d\TH:i:s" }}',
          {% if evento.data_fine %}
          end: '{{ evento.data_fine|date:"Y-m-d\TH:i:s" }}',
          {% endif %}
          url: '{{ evento.get_absolute_url }}',
          extendedProps: {
            descrizione: '{{ evento.descrizione|escapejs }}',
            luogo: '{{ evento.luogo|escapejs }}',
            {% if evento.immagine %}
            immagine: '{{ evento.immagine.url }}',
            {% endif %}
            detailUrl: '{{ evento.get_absolute_url }}'
          }
        },
        {% endfor %}
      ],
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        const evento = info.event;
        const props = evento.extendedProps;

        document.getElementById('eventoModalTitle').innerHTML = `<i class="bi bi-calendar-event me-2"></i>${evento.title}`;

        let modalContent = '';
        if (props.immagine) {
          modalContent += `<img src="${props.immagine}" alt="${evento.title}" class="evento-image-modal">`;
        }

        modalContent += `
          <div class="evento-meta-modal">
            <span><i class="bi bi-calendar"></i>${evento.start.toLocaleDateString(jsLocale, {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</span>
            <span><i class="bi bi-clock"></i>${evento.start.toLocaleTimeString(jsLocale, {hour: '2-digit', minute: '2-digit'})}${evento.end ? ' - ' + evento.end.toLocaleTimeString(jsLocale, {hour: '2-digit', minute: '2-digit'}) : ''}</span>
            <span><i class="bi bi-geo-alt"></i>${props.luogo}</span>
          </div>
        `;

        if (props.descrizione) {
          modalContent += `
            <div class="evento-description-modal">
              <h6 class="fw-semibold mb-2">{% trans "Descrizione" %}</h6>
              <p>${props.descrizione}</p>
            </div>
          `;
        }

        // Prepara i dati per i bottoni calendar
        const eventData = {
          titolo: evento.title || '',
          descrizione: props.descrizione || '',
          data: evento.start.toISOString().split('T')[0],
          oraInizio: evento.start.toTimeString().substring(0,5),
          oraFine: evento.end ? evento.end.toTimeString().substring(0,5) : evento.start.toTimeString().substring(0,5),
          luogo: props.luogo || '',
          dataLocale: evento.start.toLocaleDateString(jsLocale)
        };

        modalContent += `
          <div class="evento-actions-modal">
            <h6 class="fw-semibold mb-3 w-100">{% trans "Aggiungi al calendario" %}</h6>
            <button type="button" class="btn btn-sm btn-outline-primary" data-calendar-type="google" data-event-data='${JSON.stringify(eventData).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'>
              <i class="bi bi-google text-danger me-1"></i>{% trans "Google Calendar" %}
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-calendar-type="outlook" data-event-data='${JSON.stringify(eventData).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'>
              <i class="bi bi-microsoft text-primary me-1"></i>{% trans "Outlook" %}
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-calendar-type="apple" data-event-data='${JSON.stringify(eventData).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'>
              <i class="bi bi-apple me-1"></i>{% trans "Apple Calendar" %}
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-calendar-type="whatsapp" data-event-data='${JSON.stringify(eventData).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'>
              <i class="bi bi-whatsapp me-1"></i>{% trans "WhatsApp" %}
            </button>
          </div>
        `;

        document.getElementById('eventoModalBody').innerHTML = modalContent;
        document.getElementById('eventoDetailLink').href = props.detailUrl;
        new bootstrap.Modal(document.getElementById('eventoModal')).show();
      },
      eventDidMount: function(info) {
        // Aggiungi tooltip
        info.el.title = info.event.title;
      },
      height: 'auto',
      contentHeight: 'auto',
      aspectRatio: 1.8,
      expandRows: true,
      navLinks: true,
      editable: false,
      dayMaxEvents: true,
      views: {
        dayGridMonth: {
          dayMaxEvents: 3
        }
      }
    });

    calendar.render();
  });

  // Event delegation per i bottoni calendar - gestisce tutti i click sui bottoni
  document.addEventListener('click', function(e) {
    const button = e.target.closest('[data-calendar-type]');
    if (!button) return;
    
    try {
      const eventDataStr = button.getAttribute('data-event-data');
      if (!eventDataStr) return;
      
      // Decodifica gli escape HTML
      const decodedStr = eventDataStr.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
      const eventData = JSON.parse(decodedStr);
      const type = button.getAttribute('data-calendar-type');
      
      switch(type) {
        case 'google':
          aggiungiGoogleCalendar(eventData.titolo, eventData.descrizione, eventData.data, eventData.oraInizio, eventData.oraFine, eventData.luogo);
          break;
        case 'outlook':
          aggiungiOutlookCalendar(eventData.titolo, eventData.descrizione, eventData.data, eventData.oraInizio, eventData.oraFine, eventData.luogo);
          break;
        case 'apple':
          aggiungiAppleCalendar(eventData.titolo, eventData.descrizione, eventData.data, eventData.oraInizio, eventData.oraFine, eventData.luogo);
          break;
        case 'whatsapp':
          condividiWhatsApp(eventData.titolo, eventData.dataLocale, eventData.oraInizio, eventData.luogo);
          break;
      }
    } catch (error) {
      console.error('Errore gestione click bottone calendar:', error);
    }
  });

  // Funzioni per gestire l'aggiunta ai calendari - devono essere globali
  // Funzione per mostrare notifiche di successo
  function mostraSuccesso(messaggio) {
    const notifica = document.createElement('div');
    notifica.className = 'position-fixed fade show';
    notifica.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 320px;
      background: var(--color-success);
      color: var(--color-text-inverse);
      padding: 1rem 1.25rem;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      border: none;
      font-weight: 500;
    `;
    notifica.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi bi-check-circle me-2"></i>
        <span>${messaggio}</span>
        <button type="button" class="btn-close btn-close-white ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;

    document.body.appendChild(notifica);

    setTimeout(() => {
      notifica.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
      if (notifica.parentNode) {
        notifica.style.transform = 'translateX(100%)';
        setTimeout(() => notifica.remove(), 300);
      }
    }, 4000);
  }

  function aggiungiGoogleCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    try {
      titolo = titolo || '';
      descrizione = descrizione || '';
      luogo = luogo || '';
      
      const dataOraInizio = new Date(`${data}T${oraInizio}`);
      const dataOraFine = new Date(`${data}T${oraFine}`);
      
      if (isNaN(dataOraInizio.getTime()) || isNaN(dataOraFine.getTime())) {
        console.error('Date invalide:', data, oraInizio, oraFine);
        return;
      }
      
      const startStr = dataOraInizio.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      const endStr = dataOraFine.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      
      const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titolo)}&dates=${startStr}/${endStr}&details=${encodeURIComponent(descrizione)}&location=${encodeURIComponent(luogo)}`;
      window.open(googleUrl, '_blank');
      mostraSuccesso("{% trans 'Evento aperto in Google Calendar!' %}");
    } catch (error) {
      console.error('Errore aggiunta Google Calendar:', error);
    }
  }

  function aggiungiOutlookCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    try {
      titolo = titolo || '';
      descrizione = descrizione || '';
      luogo = luogo || '';
      
      const dataOraInizio = new Date(`${data}T${oraInizio}`);
      const dataOraFine = new Date(`${data}T${oraFine}`);
      
      if (isNaN(dataOraInizio.getTime()) || isNaN(dataOraFine.getTime())) {
        console.error('Date invalide:', data, oraInizio, oraFine);
        return;
      }
      
      const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(titolo)}&startdt=${dataOraInizio.toISOString()}&enddt=${dataOraFine.toISOString()}&body=${encodeURIComponent(descrizione)}&location=${encodeURIComponent(luogo)}`;
      window.open(outlookUrl, '_blank');
      mostraSuccesso("{% trans 'Evento aperto in Outlook!' %}");
    } catch (error) {
      console.error('Errore aggiunta Outlook Calendar:', error);
    }
  }

  function aggiungiAppleCalendar(titolo, descrizione, data, oraInizio, oraFine, luogo) {
    try {
      titolo = titolo || '';
      descrizione = descrizione || '';
      luogo = luogo || '';
      
      const dataOraInizio = new Date(`${data}T${oraInizio}`);
      const dataOraFine = new Date(`${data}T${oraFine}`);
      
      if (isNaN(dataOraInizio.getTime()) || isNaN(dataOraFine.getTime())) {
        console.error('Date invalide:', data, oraInizio, oraFine);
        return;
      }
      
      // Escape caratteri speciali per file ICS
      const escapeICS = (str) => {
        return String(str || '').replace(/[,\\;]/g, '\\$&').replace(/\n/g, '\\n');
      };
      
      const startStr = dataOraInizio.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      const endStr = dataOraFine.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      
      const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Parco Letterario Verismo//Calendar//IT\nBEGIN:VEVENT\nSUMMARY:${escapeICS(titolo)}\nDESCRIPTION:${escapeICS(descrizione)}\nLOCATION:${escapeICS(luogo)}\nDTSTART:${startStr}\nDTEND:${endStr}\nEND:VEVENT\nEND:VCALENDAR`;
      
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'evento.ics';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      mostraSuccesso("{% blocktrans %}File calendario scaricato! Aprilo per aggiungere l'evento.{% endblocktrans %}");
    } catch (error) {
      console.error('Errore aggiunta Apple Calendar:', error);
    }
  }

  function condividiWhatsApp(titolo, data, ora, luogo) {
    try {
      titolo = titolo || '';
      data = data || '';
      ora = ora || '';
      luogo = luogo || '';
      
      const messaggio = `üé≠ *${titolo}*\nüìÖ ${data} {% trans 'alle' %} ${ora}\nüìç ${luogo}\n\n{% trans 'Scopri di pi√π sul sito del Parco Letterario Giovanni Verga e Luigi Capuana!' %}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(messaggio)}`, '_blank');
      mostraSuccesso("{% trans 'Evento condiviso su WhatsApp!' %}");
    } catch (error) {
      console.error('Errore condivisione WhatsApp:', error);
    }
  }
</script>
{% endblock %}

